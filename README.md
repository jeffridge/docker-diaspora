# Diaspora*

![Diaspora Logo](https://i.imgur.com/J50tnoC.png)

[Diaspora](https://diasporafoundation.org/) is a nonprofit, user-owned, distributed social network that is based upon the free Diaspora software. Diaspora consists of a group of independently owned nodes (called pods) which interoperate to form the network.

 **Automated build of the image can be found on the [Docker Hub](https://hub.docker.com/u/nikkoura/diaspora/).**

 **forked from ultrahang/docker-diaspora**

## Features

- Based on the official [ruby:2.4-slim-stretch](https://hub.docker.com/_/ruby/) image
- Running the latest stable version of [diaspora/diaspora](https://github.com/diaspora/diaspora)
- Run as an unprivileged user (see `UID` and `GID`)
- Use of environment variables to set various configuration elements, for easier integration with other containers without modifying configuration files

### Build-time variables

- **`DIASPORA_VER`**: Diaspora version (`0.8.0.0`)
- **`GID`**: group id *(default: `942`)*
- **`UID`**: user id *(default: `942`)*

### Run-time environment variables
#### Database access
- **`DIASPORADB_TYPE`**: database type. Accepted values: `postgresql` or `mysql` (mandatory)
- **`DIASPORADB_POSTGRESQL_HOST`**: db server host (optional, default= `localhost`)
- **`DIASPORADB_POSTGRESQL_PORT`**: db server port (optional, default= `5432`)
- **`DIASPORADB_POSTGRESQL_USER`**: db server user (optional, default= `diaspora`)
- **`DIASPORADB_POSTGRESQL_PASSWORD`**: db server password (optional, default= `diaspora`)
- **`DIASPORADB_MYSQL_HOST`**: db server host (optional, default= `localhost`)
- **`DIASPORADB_MYSQL_PORT`**: db server port (optional, default= `3306`)
- **`DIASPORADB_MYSQL_USER`**: db server user (optional, default= `root`)
- **`DIASPORADB_MYSQL_PASSWORD`**: db server password (optional, default: empty)

#### Redis access
- **`DIASPORA_ENVIRONMENT_REDIS`**: REDIS url, optionally including user/password (default= `redis://redis`)

#### Base settings
- **`DIASPORA_ENVIRONMENT_URL`**: diaspora public URL. Do not modify once db has been populated (optional, default= `http://localhost`)
- **`DIASPORA_ENVIRONMENT_REQUIRESSL`**: indicates wether Diaspora will require SSL for incoming connections - set to `true` or `false` (default= `false`)
- **`DIASPORA_SERVER_LISTEN`**: Diaspora 'unicorn' server listener (default= `0.0.0.0:3000`)


### Volumes

- **`/diaspora/public`**: location of the assets and user uploads

## Usage

### Configuration files

Diaspora is mainly configured by two files in the container: `/diaspora/config/database.yml` and `/diaspora/config/diaspora.yml`
Both files are generated by the container entry points, using [confd](http://www.confd.io), templates and environment variables. This allows container configuration by using environment variables, which
facilitates integration in some environments.
Should you wish to make additional modifications to these configuration files, you can do so by modifying the templates, either:
- in the container: `/etc/confd/templates`
- by building a custom image: see `confd/templates`

### Docker Compose

A sample Docker Compose file is provided. It instanciates standalones instances of PostreSQL and REDIS,
and a NGinx web server to serve static elements (assets and user uploads).
It can be used for a basic deployment, with minor modifications to environment variables.

We need a Nginx container to server the uploads and assets, as Unicorn doesn't do it.

### Installation

When running the instance for the first time, run this command to setup the database:

```sh
docker-compose run --rm unicorn initdb
```

Then compile the assets:

```sh
docker-compose run --rm unicorn precompile-assets
```

You can now lauch your pod!

```sh
docker-compose up -d
```

You can check your Diaspora installation on the http://localhost with no modification on the configuration files. To set the administrator account follow the [Official FAQ instructions](https://wiki.diasporafoundation.org/FAQ_for_pod_maintainers#What_are_roles_and_how_do_I_use_them.3F_.2F_Make_yourself_an_admin_or_assign_moderators) after creating an account on the site.
